// ToH Fangame â€” ìµœì¢… ë³´ì•ˆ ê·œì¹™ (v4)
// writeBatchì™€ì˜ ì¶©ëŒì„ ì™„ë²½íˆ í•´ê²°í•˜ê¸° ìœ„í•´ ê·œì¹™ì„ ìµœì¢…ì ìœ¼ë¡œ ì •ë¦¬í•œ ë²„ì „ì…ë‹ˆë‹¤.
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== ğŸ ìµœì¢… ë””ë²„ê¹…ìš© í…ŒìŠ¤íŠ¸ ê·œì¹™ =====
    // ì´ ê·œì¹™ì€ ì˜¤ì§ ì¸ì¦ ìƒíƒœê°€ ì •ìƒì¸ì§€ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
    match /test_writes/{docId} {
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
    }

    // ===== ê³µí†µ í—¬í¼ í•¨ìˆ˜ =====
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(data) {
      return isSignedIn() && data.owner_uid == request.auth.uid;
    }
    // ì°¸ê³ : get()ì„ ì‚¬ìš©í•˜ëŠ” charOwner í•¨ìˆ˜ëŠ” ë‹¤ë¥¸ ê³³(char_items)ì—ì„œ ì—¬ì „íˆ ì‚¬ìš©ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    function charOwner(charPath) {
      return get(/databases/$(database)/documents/$(charPath)).data.owner_uid;
    }

    // ===== ìºë¦­í„° (chars) =====
    match /chars/{charId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.owner_uid == request.auth.uid;
      // 'update' ê·œì¹™ì€ ê¸°ì¡´ ë¬¸ì„œì˜ ì†Œìœ ìì¸ì§€ í™•ì¸í•˜ë¯€ë¡œ ì•ˆì „í•©ë‹ˆë‹¤.
      allow update: if isOwner(resource.data);
      allow delete: if isOwner(resource.data);

      match /images/{imageDoc} {
        allow read: if true;
        allow create, update, delete: if isSignedIn()
          && get(/databases/$(database)/documents/chars/$(charId)).data.owner_uid == request.auth.uid;
      }
    }
    
    // ===== ìºë¦­í„° ì¸ë²¤í† ë¦¬ (char_items) =====
    match /char_items/{itemId} {
        allow read: if true;
        allow create: if isSignedIn()
            && request.resource.data.char_id.matches('^chars/[^/]+$')
            && charOwner(request.resource.data.char_id) == request.auth.uid;
        allow update, delete: if isSignedIn()
            && resource.data.char_id.matches('^chars/[^/]+$')
            && charOwner(resource.data.char_id) == request.auth.uid;
    }
    
    // ===== íƒí—˜ (explore_runs) =====
    // âš ï¸ ìµœì¢… ìˆ˜ì •: ìƒì„± ê·œì¹™ì„ ê°€ì¥ ë‹¨ìˆœí•œ í˜•íƒœë¡œ ìœ ì§€í•˜ì—¬ writeBatchì™€ì˜ ì¶©ëŒì„ ì›ì²œì ìœ¼ë¡œ ë°©ì§€í•©ë‹ˆë‹¤.
    match /explore_runs/{runId} {
      allow read: if isOwner(resource.data);
      
      // ìƒì„±: í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ë°ì´í„°(payload)ì˜ owner_uidê°€
      // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ uidì™€ ì¼ì¹˜í•˜ëŠ”ì§€ë§Œ í™•ì¸í•©ë‹ˆë‹¤.
      // ì´ ê·œì¹™ì€ ë‹¤ë¥¸ ë¬¸ì„œë¥¼ ì½ì–´ì˜¤ì§€ ì•Šìœ¼ë¯€ë¡œ(get() ì—†ìŒ)çµ¶å¯¾ã« ì•ˆì „í•©ë‹ˆë‹¤.
      allow create: if isSignedIn() && request.resource.data.owner_uid == request.auth.uid;
        
      allow update: if isOwner(resource.data)
        && !('owner_uid' in request.resource.data)
        && !('charRef' in request.resource.data);

      allow delete: if false;
    }

    // (ì´í•˜ ë‹¤ë¥¸ ê·œì¹™ë“¤ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤)
    // ===== ìœ ì € í”„ë¡œí•„ (users) =====
    match /users/{uid} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow update: if isSignedIn() && request.auth.uid == uid
        && (!('nickname' in request.resource.data) || request.resource.data.nickname.size() <= 20)
        && (
          !('nickname' in request.resource.data)
          || !('nickname' in resource.data)
          || request.resource.data.nickname == resource.data.nickname
          || !('lastNicknameChangeAt' in resource.data)
          || (request.time.toMillis() - resource.data.lastNicknameChangeAt > 7 * 24 * 60 * 60 * 1000)
        );
    }

    // ===== ì¹œêµ¬ ìš”ì²­ (friendRequests) =====
    match /friendRequests/{reqId} {
      allow read: if isSignedIn() && (request.auth.uid == resource.data.from || request.auth.uid == resource.data.to);
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.from;
      allow update: if isSignedIn() && request.auth.uid == resource.data.to;
      allow delete: if isSignedIn() && (request.auth.uid == resource.data.from || request.auth.uid == resource.data.to);
    }

    // ===== ì¹œêµ¬ ê´€ê³„ (friendships) =====
    match /friendships/{pairId} {
      allow read, delete: if isSignedIn() && (request.auth.uid == resource.data.a || request.auth.uid == resource.data.b);
      allow create: if isSignedIn() && (request.auth.uid == request.resource.data.a || request.auth.uid == request.resource.data.b);
    }
    
    // ===== ë§¤ì¹­ ì„¸ì…˜ (matchSessions) =====
    match /matchSessions/{sid} {
      allow read: if isSignedIn() && (request.auth.uid == resource.data.a_owner || request.auth.uid == resource.data.b_owner);
      allow write: if false;
    }
    
    // ===== ë§¤ì¹­ ëŒ€ê¸°ì—´ (matchRequests) =====
    match /matchRequests/{rid} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
        && request.resource.data.owner_uid == request.auth.uid
        && request.resource.data.status == "open"
        && request.resource.data.lockedBy == null
        && request.resource.data.char_ref.matches('^chars/[^/]+$');
      allow update: if isSignedIn()
        && (
          ( resource.data.owner_uid == request.auth.uid
            && (request.resource.data.status in ["open","paired","cancelled"])
            && request.resource.data.lockedBy == resource.data.lockedBy
          ) || ( 
            resource.data.owner_uid != request.auth.uid
            && resource.data.lockedBy == null
            && request.resource.data.lockedBy != null
            && request.resource.data.status == resource.data.status
          )
        );
      allow delete: if isSignedIn()
        && (
          resource.data.owner_uid == request.auth.uid
          || (('expireAt' in resource.data) && resource.data.expireAt < request.time)
        );
    }

    // ===== ì½ê¸° ì „ìš© ì»¬ë ‰ì…˜ =====
    match /rankings/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /configs/{docId}/{subpath=**} {
      allow read: if true;
      allow write: if false;
    }

    // ===== ê¸°ë³¸ ì°¨ë‹¨ ê·œì¹™ =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


