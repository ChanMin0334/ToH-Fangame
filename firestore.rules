// ToH Fangame — 최종 디버깅용 보안 규칙
// ⚠️ 경고: 이 규칙은 모든 쓰기 권한을 허용하므로, 테스트 직후 반드시 이전 버전으로 되돌려야 합니다.
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== 공통 헬퍼 함수 =====
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(data) {
      return isSignedIn() && data.owner_uid == request.auth.uid;
    }
    function charOwner(charPath) {
      return get(/databases/$(database)/documents/$(charPath)).data.owner_uid;
    }

    // ===== 캐릭터 (chars) =====
    match /chars/{charId} {
      allow read: if true;
      // ⚠️ DEBUG: 인증 확인 없이 모든 생성/업데이트/삭제를 임시로 허용합니다.
      allow write: if true;

      match /images/{imageDoc} {
        allow read: if true;
        allow write: if true;
      }
    }
    
    // ===== 캐릭터 인벤토리 (char_items) =====
    match /char_items/{itemId} {
        allow read: if true;
        // ⚠️ DEBUG: 임시로 허용
        allow write: if true;
    }
    
    // ===== 탐험 (explore_runs) =====
    match /explore_runs/{runId} {
      // ⚠️ DEBUG: 임시로 허용
      allow read, write: if true;
    }

    // (이하 다른 규칙들은 설명을 위해 생략되었지만, 위 규칙들이 우선 적용됩니다)
    // ===== 유저 프로필 (users) =====
    match /users/{uid} {
      allow read, write: if true;
    }

    // ===== 친구 요청 (friendRequests) =====
    match /friendRequests/{reqId} {
      allow read, write: if true;
    }

    // ===== 친구 관계 (friendships) =====
    match /friendships/{pairId} {
      allow read, write: if true;
    }
    
    // ===== 매칭 세션 (matchSessions) =====
    match /matchSessions/{sid} {
      allow read: if true;
      allow write: if false; // Functions만 쓰기 가능
    }
    
    // ===== 매칭 대기열 (matchRequests) =====
    match /matchRequests/{rid} {
      allow read, write: if true;
    }

    // ===== 읽기 전용 컬렉션 =====
    match /rankings/{docId} {
      allow read: if true;
      allow write: if false;
    }
    match /configs/{docId}/{subpath=**} {
      allow read: if true;
      allow write: if false;
    }

    // ===== 기본 차단 규칙 (임시로 비활성화) =====
    // match /{document=**} {
    //   allow read, write: if false;
    // }
  }
}
